<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silicorp Crisis Simulation (Advanced)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        .chat-bubble { max-width: 80%; padding: 12px 16px; border-radius: 16px; word-wrap: break-word; position: relative; }
        .user-bubble { background-color: #0055A5; color: white; border-bottom-right-radius: 4px; }
        .ai-bubble { background-color: #4A5568; color: white; border-bottom-left-radius: 4px; }
        
        .user-bubble::after { content: ''; position: absolute; bottom: 0; right: -8px; width: 0; height: 0; border: 10px solid transparent; border-left-color: #0055A5; border-bottom-color: #0055A5; }
        .ai-bubble::after { content: ''; position: absolute; bottom: 0; left: -8px; width: 0; height: 0; border: 10px solid transparent; border-right-color: #4A5568; border-bottom-color: #4A5568; }

        #chat-container::-webkit-scrollbar { width: 6px; }
        #chat-container::-webkit-scrollbar-track { background: #F3F4F6; }
        #chat-container::-webkit-scrollbar-thumb { background: #D1D5DB; border-radius: 3px; }
        #briefing-panel { transition: transform 0.3s ease-in-out; }
        
        /* Ensure the main container respects the dynamic height */
        #main-container {
            height: 100vh; /* Fallback for desktop */
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="main-container" class="w-full h-screen flex">
        <!-- API Key Lobby -->
        <div id="lobby" class="fixed inset-0 bg-gray-800 flex items-center justify-center z-50">
            <div class="bg-white text-gray-800 rounded-lg shadow-2xl p-8 max-w-md w-11/12 text-center">
                <h2 class="text-2xl font-bold mb-4">Welcome to the Silicorp Simulation</h2>
                <p class="mb-6 text-gray-600">To begin, please enter your Gemini API key. The key will be stored only in your browser for this session.</p>
                <input type="password" id="apiKeyInput" class="w-full border-2 border-gray-300 rounded-lg p-3 mb-4 text-center" placeholder="Paste your Gemini API key here">
                <button id="startSimButton" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">Start Simulation</button>
                <a href="https://makersuite.google.com/app/apikey" target="_blank" class="block mt-4 text-sm text-blue-600 hover:underline">Get a free API key from Google AI Studio</a>
                <p id="keyError" class="text-red-500 text-sm mt-2 h-4"></p>
            </div>
        </div>

        <!-- Main Simulation UI (Initially Hidden) -->
        <div id="simulation-ui" class="flex h-full w-full hidden">
            <!-- Case Briefing Panel -->
            <div id="briefing-panel" class="w-full md:w-1/3 lg:w-1/4 bg-white p-6 overflow-y-auto shadow-lg absolute md:relative inset-0 z-30 transform -translate-x-full md:translate-x-0">
                <div class="flex justify-between items-center mb-4">
                    <h1 class="text-2xl font-bold text-gray-800">Your Mission</h1>
                    <button id="hideBriefingBtn" class="md:hidden p-2 rounded-full hover:bg-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <div>
                    <h2 class="text-lg font-semibold text-gray-700 mb-2">Rebuilding a Strategic Partnership</h2>
                    <p class="text-sm text-gray-600 mb-4">You are **Sarah Jenkins**, Key Account Director at Silicorp. Your largest client, AutonoDrive, suffered a major market share loss after Silicorp failed to provide innovative support for their new product launch. The exclusive partnership is now at risk.</p>
                    <p class="text-sm text-gray-600 mb-4">Your customer, **Mark Chen (VP of Strategic Partnerships)**, is questioning the fundamental value of the partnership.</p>
                    <p class="text-sm text-gray-600 font-semibold">Your Goal: Convince Mark that Silicorp is still the right strategic partner for the future.</p>
                </div>
                <div class="mt-6">
                     <h2 class="text-lg font-semibold text-gray-800 mb-3">Account Vitals:</h2>
                    <ul class="list-disc list-inside text-sm text-gray-600 space-y-2">
                        <li>**Annual Revenue:** $400 Million (18% of Silicorp's total revenue).</li>
                        <li>**Profit Margin:** 35% (vs. company average of 28%).</li>
                        <li>**5-Year Growth Projection:** Expected to reach $750 Million annually.</li>
                        <li>**Status:** High-growth, high-profit, and strategically critical.</li>
                    </ul>
                </div>
                <div class="mt-6">
                    <h2 class="text-lg font-semibold text-gray-800 mb-3">Key Facts:</h2>
                    <ul class="list-disc list-inside text-sm text-gray-600 space-y-2">
                        <li>**The Crisis:** Your failure to innovate cost AutonoDrive a major market opportunity.</li>
                        <li>**The Threat:** AutonoDrive is actively meeting with your competitors.</li>
                    </ul>
                </div>
            </div>

            <!-- Chat Interface -->
            <div class="flex-1 flex flex-col bg-gray-200">
                <header class="bg-white shadow-md p-4 flex items-center justify-between flex-shrink-0">
                    <div class="flex items-center">
                        <button id="showBriefingBtn" class="md:hidden mr-4 p-2 rounded-full hover:bg-gray-200">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" /></svg>
                        </button>
                        <div class="flex items-center">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center mr-4 relative">
                               <img src="https://placehold.co/80x80/4A5568/FFFFFF?text=M" alt="Mark Chen" class="rounded-full">
                            </div>
                            <div>
                                <h2 id="participant-header" class="text-lg font-semibold text-gray-900">Mark Chen, VP Strategic Partnerships</h2>
                                <p class="text-sm text-red-500 flex items-center"><span class="w-2 h-2 bg-red-500 rounded-full mr-2"></span>Partnership Under Review</p>
                            </div>
                        </div>
                    </div>
                </header>

                <div id="chat-container" class="flex-1 p-6 overflow-y-auto space-y-4"></div>

                <footer class="bg-white p-4 border-t border-gray-300 flex-shrink-0">
                    <div id="end-sim-options" class="hidden text-center">
                        <button id="reviewButton" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700">✨ Get My Performance Review</button>
                        <button id="restartButton" class="ml-4 bg-gray-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-600">Restart Simulation</button>
                    </div>
                    <div id="chat-input-area" class="flex items-center">
                        <input type="text" id="userInput" class="flex-1 border-gray-300 rounded-full py-3 px-4" placeholder="Type your response...">
                        <button id="suggestButton" class="ml-2 p-3 text-white bg-purple-600 rounded-full hover:bg-purple-700" title="Suggest a Reply">✨</button>
                        <button id="sendButton" class="ml-2 bg-blue-600 text-white rounded-full p-3 hover:bg-blue-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                        </button>
                    </div>
                </footer>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="aiModal" class="fixed inset-0 flex items-center justify-center hidden z-40">
        <div class="absolute inset-0 bg-gray-900 opacity-50"></div>
        <div class="bg-white w-11/12 md:max-w-2xl mx-auto rounded-lg shadow-lg z-50 flex flex-col max-h-[85vh]">
            <div class="flex-shrink-0 flex justify-between items-center p-4 border-b">
                <p id="modalTitle" class="text-xl font-bold">✨ AI Assistant</p>
                <button id="closeModal" class="p-1"><svg class="fill-current text-black h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18"><path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path></svg></button>
            </div>
            <div class="flex-grow overflow-y-auto p-6"><div id="modalBody" class="prose max-w-none"></div></div>
        </div>
    </div>
    <div id="pressureModal" class="fixed inset-0 flex items-center justify-center hidden z-50">
        <div class="absolute inset-0 bg-gray-900 opacity-75"></div>
        <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-6 rounded-lg shadow-2xl z-50 w-11/12 md:max-w-lg">
            <div class="flex">
                <div class="py-1"><svg class="fill-current h-6 w-6 text-yellow-500 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M2.93 17.07A10 10 0 1 1 17.07 2.93 10 10 0 0 1 2.93 17.07zM9 11v4h2v-4H9zm0-4h2v2H9V7z"/></svg></div>
                <div>
                    <p id="pressureMessage" class="font-bold"></p>
                    <p id="pressureFrom" class="text-sm"></p>
                </div>
            </div>
             <button id="closePressureModal" class="mt-4 bg-yellow-500 text-white py-2 px-4 rounded hover:bg-yellow-600">Acknowledge</button>
        </div>
    </div>

    <script>
        // DOM Elements
        const elements = {
            mainContainer: document.getElementById('main-container'),
            lobby: document.getElementById('lobby'),
            simulationUI: document.getElementById('simulation-ui'),
            apiKeyInput: document.getElementById('apiKeyInput'),
            startSimButton: document.getElementById('startSimButton'),
            keyError: document.getElementById('keyError'),
            chatContainer: document.getElementById('chat-container'),
            userInput: document.getElementById('userInput'),
            sendButton: document.getElementById('sendButton'),
            suggestButton: document.getElementById('suggestButton'),
            reviewButton: document.getElementById('reviewButton'),
            restartButton: document.getElementById('restartButton'),
            chatInputArea: document.getElementById('chat-input-area'),
            endSimOptions: document.getElementById('end-sim-options'),
            aiModal: document.getElementById('aiModal'),
            modalTitle: document.getElementById('modalTitle'),
            modalBody: document.getElementById('modalBody'),
            closeModal: document.getElementById('closeModal'),
            pressureModal: document.getElementById('pressureModal'),
            pressureMessage: document.getElementById('pressureMessage'),
            pressureFrom: document.getElementById('pressureFrom'),
            closePressureModal: document.getElementById('closePressureModal'),
            briefingPanel: document.getElementById('briefing-panel'),
            showBriefingBtn: document.getElementById('showBriefingBtn'),
            hideBriefingBtn: document.getElementById('hideBriefingBtn'),
        };

        // State
        let chatHistory = [];
        let turnCount = 0;
        let apiKey = '';

        // --- Mobile Viewport Height Fix ---
        function setAppHeight() {
            const doc = document.documentElement;
            doc.style.setProperty('--app-height', `${window.innerHeight}px`);
            elements.mainContainer.style.height = `${window.innerHeight}px`;
        }
        window.addEventListener('resize', setAppHeight);
        
        // --- Gemini API Call Function ---
        async function callGemini(prompt, isJson = false) {
            const apiUrl = `/.netlify/functions/getAiResponse`;
            try {
                const response = await fetch(apiUrl, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ prompt, isJson }) 
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Backend function error');
                }
                const result = await response.json();
                return result.text;
            } catch (error) {
                console.error("Backend Call Error:", error);
                return `Sorry, the AI assistant is currently unavailable. Error: ${error.message}`;
            }
        }
        
        // --- Lobby Logic (Removed for this version, but keeping structure for potential future use) ---
        function initializeSim() {
            elements.lobby.classList.add('hidden');
            elements.simulationUI.classList.remove('hidden');
            startConversation();
        }

        // --- Modal & UI Functions ---
        function openModal(title, content) {
            elements.modalTitle.textContent = title;
            elements.modalBody.innerHTML = content;
            elements.aiModal.classList.remove('hidden');
        }
        function closeModalFunction() { elements.aiModal.classList.add('hidden'); }
        function showPressureAlert(message, from) {
            elements.pressureMessage.textContent = message;
            elements.pressureFrom.textContent = `From: ${from}`;
            elements.pressureModal.classList.remove('hidden');
        }

        // --- Core Chat Functions ---
        function startConversation() {
            elements.chatContainer.innerHTML = '';
            chatHistory = [];
            turnCount = 0;
            elements.chatInputArea.classList.remove('hidden');
            elements.endSimOptions.classList.add('hidden');
            const initialMessage = "Sarah, good to connect. Frankly, our last product launch was a disaster, and Silicorp's lack of support was a major factor. My leadership is questioning the value of our exclusive partnership. Convince me why we shouldn't open up discussions with your competitors.";
            addMessageToChat('Mark Chen', initialMessage);
        }

        function addMessageToChat(speaker, message) {
            const isUser = speaker.startsWith('Sarah');
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex items-end gap-2 ${isUser ? 'justify-end' : ''}`;
            const avatar = document.createElement('img');
            avatar.className = 'w-8 h-8 rounded-full flex-shrink-0';
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${isUser ? 'user-bubble' : 'ai-bubble'}`;
            bubble.textContent = message;
            let avatarUrl = isUser ? 'https://placehold.co/40x40/E2E8F0/4A5568?text=S' : 'https://placehold.co/40x40/4A5568/FFFFFF?text=M';
            avatar.src = avatarUrl;
            avatar.alt = `${speaker} avatar`;
            if (isUser) {
                messageWrapper.appendChild(bubble);
                messageWrapper.appendChild(avatar);
            } else {
                messageWrapper.appendChild(avatar);
                messageWrapper.appendChild(bubble);
            }
            elements.chatContainer.appendChild(messageWrapper);
            elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;
            chatHistory.push(`${speaker}: ${message}`);
        }

        async function handleUserInput() {
            const message = elements.userInput.value.trim();
            if (!message) return;
            addMessageToChat('Sarah (You)', message);
            elements.userInput.value = '';
            turnCount++;
            setInputsDisabled(true);
            if (turnCount === 2) {
                showPressureAlert("That exclusivity clause is our biggest leverage. Do not give it up without a major financial commitment from their side.", "VP of Sales");
            }
            const aiResponse = await getDynamicAIResponse();
            addMessageToChat('Mark Chen', aiResponse);
            setInputsDisabled(false);
            if (turnCount >= 5) {
                elements.chatInputArea.classList.add('hidden');
                elements.endSimOptions.classList.remove('hidden');
            }
        }
        
        function setInputsDisabled(disabled) {
            elements.userInput.disabled = disabled;
            elements.sendButton.disabled = disabled;
            elements.suggestButton.disabled = disabled;
        }

        async function getDynamicAIResponse() {
            const historyText = chatHistory.join('\n');
            const prompt = `You are Mark Chen, VP of Strategic Partnerships. You are strategic, disappointed, and focused on the future vision of the partnership.
                **Instructions:**
                - Respond *only* as Mark Chen.
                - Keep your responses to 1-2 concise sentences.
                - Analyze the conversation history and Sarah's last message to formulate your response.
                **Conversation History:**
                ${historyText}
                **Based on Sarah's last message, what is your direct response?**`;
            openModal('✨ AI Assistant', `<p>Mark is thinking...</p>`);
            const response = await callGemini(prompt);
            closeModalFunction();
            return response;
        }

        // --- AI Feature Handlers ---
        async function handleSuggestReply() {
            openModal('✨ AI Reply Suggestions', '<p>Generating suggestions...</p>');
            const historyText = chatHistory.join('\n');
            const lastMessage = chatHistory[chatHistory.length - 1];
            const prompt = `You are a sales coach advising Sarah. She is in a tough negotiation with Mark (strategic VP).
                The conversation so far is: ${historyText}
                Mark just said: "${lastMessage}"
                Generate three distinct, effective options for Sarah's next reply. The options must address Mark's concerns. Return as a JSON object with a "suggestions" key containing an array of strings.`;
            const response = await callGemini(prompt, true);
            try {
                const parsedResponse = JSON.parse(response);
                let suggestionsHtml = '<p>Here are a few options. Click one to copy it to your input box.</p><ul class="mt-4 space-y-3">';
                parsedResponse.suggestions.forEach((s, i) => {
                    suggestionsHtml += `<li class="p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-blue-100" onclick="useSuggestion('${s.replace(/'/g, "\\'")}')"><strong>Option ${i + 1}:</strong> ${s}</li>`;
                });
                elements.modalBody.innerHTML = suggestionsHtml + '</ul>';
            } catch (e) {
                elements.modalBody.innerHTML = `<p>Sorry, there was an error processing the AI's response.</p>`;
            }
        }
        function useSuggestion(text) {
            elements.userInput.value = text;
            closeModalFunction();
            elements.userInput.focus();
        }
        async function handlePerformanceReview() {
            openModal('✨ Performance Review', '<p>Analyzing your performance...</p>');
            const historyText = chatHistory.join('\n');
            const prompt = `You are an MBA professor grading a student's role-play. The student, Sarah, negotiated with Mark (strategic VP).
                Analyze the transcript. Provide a performance review in Markdown covering:
                1.  **Strategic Pivot:** Did they move from apologizing to proposing value?
                2.  **Commercial Acumen:** How well did they handle the internal pressure and address the customer's strategic needs?
                3.  **Overall Grade (A-F):**
                4.  **Key Learning Moment:** What was the single most important thing they could have done differently?
                **Transcript:**
                ${historyText}`;
            const reviewText = await callGemini(prompt);
            elements.modalBody.innerHTML = reviewText.replace(/### (.*)/g, '<h3>$1</h3>').replace(/## (.*)/g, '<h2>$1</h2>').replace(/\*\*(.*)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
        }

        // --- Event Listeners ---
        // Hiding lobby listeners for this version, but keeping them for easy toggling
        // elements.startSimButton.addEventListener('click', validateAndStart);
        // elements.apiKeyInput.addEventListener('keydown', (e) => e.key === 'Enter' && validateAndStart());
        elements.sendButton.addEventListener('click', handleUserInput);
        elements.userInput.addEventListener('keydown', (e) => e.key === 'Enter' && handleUserInput());
        elements.suggestButton.addEventListener('click', handleSuggestReply);
        elements.reviewButton.addEventListener('click', handlePerformanceReview);
        elements.restartButton.addEventListener('click', startConversation);
        elements.closeModal.addEventListener('click', closeModalFunction);
        elements.aiModal.querySelector('.absolute.inset-0').addEventListener('click', closeModalFunction);
        elements.closePressureModal.addEventListener('click', () => elements.pressureModal.classList.add('hidden'));
        elements.showBriefingBtn.addEventListener('click', () => elements.briefingPanel.classList.remove('-translate-x-full'));
        elements.hideBriefingBtn.addEventListener('click', () => elements.briefingPanel.classList.add('-translate-x-full'));

        // --- Initial Load ---
        window.onload = () => {
            setAppHeight();
            // In this version, we bypass the lobby and start directly
            elements.lobby.classList.add('hidden');
            elements.simulationUI.classList.remove('hidden');
            startConversation();
        };
    </script>
</body>
</html>

